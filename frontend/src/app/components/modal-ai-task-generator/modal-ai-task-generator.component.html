<nz-modal
  [(nzVisible)]="isVisible"
  nzTitle="T·∫°o vi·ªác v·ªõi AI"
  (nzOnCancel)="handleCancel()"
  [nzContent]="modalContent"
  [nzFooter]="modalFooter"
  nzWidth="800px">

  <ng-template #modalContent>
    <div class="ai-task-generator">
      <!-- Upload Section -->
      <div *ngIf="!aiSuggestion && !isProcessing" class="upload-section">
        <div class="upload-description">
          <p>AI s·∫Ω ƒë·ªçc v√† ph√¢n t√≠ch n·ªôi dung file ƒë·ªÉ t·∫°o ra c√°c c√¥ng vi·ªác ph√π h·ª£p</p>
        </div>
        <nz-upload
          class="upload-area"
          nzType="drag"
          [nzMultiple]="false"
          [nzShowUploadList]="false"
          [nzBeforeUpload]="beforeUpload"
          (nzFileListChange)="handleFileChange($event)">
          <p class="ant-upload-drag-icon">
            <i nz-icon nzType="inbox"></i>
          </p>
          <p class="ant-upload-text">K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
          <p class="ant-upload-hint">
            H·ªó tr·ª£ c√°c ƒë·ªãnh d·∫°ng: PDF, DOC, DOCX, TXT
          </p>
        </nz-upload>
        <div *ngIf="selectedFile" class="selected-file">
          <div class="file-info">
            <i nz-icon nzType="file-text"></i>
            <span>{{ selectedFile.name }}</span>
            <button nz-button nzType="text" nzSize="small" (click)="removeFile()">
              <i nz-icon nzType="close"></i>
            </button>
          </div>
          <div style="text-align:center;color:#888;font-size:13px;margin-top:4px;">
            Ch·ªçn l·∫°i file kh√°c n·∫øu mu·ªën thay ƒë·ªïi
          </div>
        </div>
      </div>

      <!-- Processing Section -->
      <div *ngIf="isProcessing" class="processing-section">
        <nz-spin nzSize="large">
          <div class="processing-content">
            <h4>üß† AI ƒëang ph√¢n t√≠ch file...</h4>
            <p>Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
          </div>
        </nz-spin>
      </div>

      <!-- AI Suggestion Section (Preview gi·ªëng AI Agent) -->
      <div *ngIf="aiSuggestion && !isProcessing" class="suggestion-content">
        <!-- Main Task Card -->
        <nz-card class="main-task-card" nzTitle="üìã C√¥ng vi·ªác ch√≠nh"
          [nzExtra]="mainTaskActions">
          <ng-template #mainTaskActions>
            <div class="main-task-extra">
              <span class="file-info">
                <i nz-icon nzType="file-text"></i>
                T·ª´ file: <strong>{{ fileName }}</strong>
              </span>
              <button nz-button nzType="primary" nzSize="small"
                (click)="copyContent(aiSuggestion!.title + '\n\n' + aiSuggestion!.description)">
                <i nz-icon nzType="copy"></i>
                Copy
              </button>
            </div>
          </ng-template>
          <div class="task-info">
            <h3 class="task-title">{{ aiSuggestion.title }}</h3>
            <div class="task-meta">
              <nz-tag nzColor="blue">
                <i nz-icon nzType="calendar"></i>
                {{ aiSuggestion.startDate }} - {{ aiSuggestion.endDate }}
              </nz-tag>
              <nz-tag nzColor="orange">
                <i nz-icon nzType="branches"></i>
                {{ aiSuggestion.subtasks.length }} c√¥ng vi·ªác con
              </nz-tag>
            </div>
            <div class="task-description">
              <h4>M√¥ t·∫£:</h4>
              <p>{{ aiSuggestion.description }}</p>
            </div>
          </div>
        </nz-card>

        <!-- Toggle Subtasks Button -->
        <div class="subtasks-toggle-section" style="text-align:center;margin:24px 0;">
          <button nz-button nzType="default" nzSize="large"
            class="toggle-subtasks-btn"
            (click)="isSubtasksVisible = !isSubtasksVisible">
            <i nz-icon [nzType]="isSubtasksVisible ? 'up' : 'down'"></i>
            <span>
              {{ isSubtasksVisible ? '·∫®n' : 'Xem' }} c√¥ng vi·ªác con ({{ aiSuggestion.subtasks.length }})
            </span>
          </button>
        </div>

        <!-- Subtasks Section -->
        <div class="subtasks-section"
          [class.visible]="isSubtasksVisible"
          [class.hidden]="!isSubtasksVisible">
          <div class="subtasks-header" *ngIf="isSubtasksVisible">
            <h3>üìù C√°c c√¥ng vi·ªác con ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t</h3>
            <span class="summary-text">
              T·ªïng c·ªông {{ aiSuggestion.subtasks.length }} c√¥ng vi·ªác con
            </span>
          </div>
          <div class="subtasks-list" *ngIf="isSubtasksVisible">
            <nz-card *ngFor="let subtask of aiSuggestion.subtasks; let i = index"
              class="subtask-card"
              [nzTitle]="'C√¥ng vi·ªác con ' + (i + 1)"
              [nzExtra]="subtaskActions">
              <ng-template #subtaskActions>
                <button nz-button nzType="text" nzSize="small"
                  (click)="copyContent(subtask.title + '\n\n' + subtask.description)">
                  <i nz-icon nzType="copy"></i>
                  Copy
                </button>
              </ng-template>
              <div class="subtask-info">
                <h4 class="subtask-title">{{ subtask.title }}</h4>
                <div class="subtask-meta">
                  <nz-tag nzColor="cyan" nzSize="small">
                    <i nz-icon nzType="calendar"></i>
                    {{ subtask.startDate }} - {{ subtask.dueDate }}
                  </nz-tag>
                </div>
                <div class="subtask-description">
                  <h5>M√¥ t·∫£:</h5>
                  <p>{{ subtask.description }}</p>
                </div>
              </div>
            </nz-card>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template #modalFooter>
    <button nz-button nzType="default" (click)="handleCancel()">
      H·ªßy b·ªè
    </button>
    <button
      *ngIf="selectedFile && !isProcessing && !aiSuggestion"
      nz-button
      nzType="primary"
      (click)="generateWithAI()"
      [nzLoading]="isProcessing">
      <i nz-icon nzType="thunderbolt"></i>
      T·∫°o v·ªõi AI
    </button>
    <button
      *ngIf="aiSuggestion && !isProcessing"
      nz-button
      nzType="primary"
      (click)="applyTasks()">
      <i nz-icon nzType="check"></i>
      √Åp d·ª•ng c√¥ng vi·ªác
    </button>
  </ng-template>
</nz-modal>