<div *ngIf="isVisible" class="ai-generator-section">
  <div class="ai-generator-header">
    <h3>T·∫°o vi·ªác v·ªõi AI</h3>
    <button nz-button nzType="text" (click)="close()">
      <i nz-icon nzType="close"></i>
    </button>
  </div>

  <!-- Upload Section -->
  <div *ngIf="!aiSuggestion && !isProcessing" class="upload-section">
    <div class="upload-description">
      <p>AI s·∫Ω ƒë·ªçc v√† ph√¢n t√≠ch n·ªôi dung file ƒë·ªÉ t·∫°o ra c√°c c√¥ng vi·ªác ph√π h·ª£p</p>
    </div>
    
    <nz-upload
      class="upload-area"
      nzType="drag"
      [nzMultiple]="false"
      [nzShowUploadList]="false"
      [nzBeforeUpload]="beforeUpload">
      <p class="ant-upload-drag-icon">
        <i nz-icon nzType="inbox"></i>
      </p>
      <p class="ant-upload-text">K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
      <p class="ant-upload-hint">H·ªó tr·ª£ c√°c ƒë·ªãnh d·∫°ng: PDF, DOC, DOCX, TXT</p>
    </nz-upload>
    
    <div *ngIf="selectedFile" class="selected-file">
      <div class="file-info">
        <i nz-icon nzType="file-text"></i>
        <span>{{ selectedFile.name }}</span>
        <button nz-button nzType="text" nzSize="small" (click)="removeFile()">
          <i nz-icon nzType="close"></i>
        </button>
      </div>
      <small class="help-text">Ch·ªçn l·∫°i file kh√°c n·∫øu mu·ªën thay ƒë·ªïi</small>
      
      <div class="upload-actions">
        <button
          nz-button
          nzType="primary"
          (click)="generateWithAI()"
          [nzLoading]="isProcessing">
          <i nz-icon nzType="thunderbolt"></i>
          T·∫°o v·ªõi AI
        </button>
      </div>
    </div>
  </div>

  <!-- Processing Section -->
  <div *ngIf="isProcessing" class="processing-section">
    <nz-spin nzSize="large">
      <div class="processing-content">
        <h4>AI ƒëang ph√¢n t√≠ch file...</h4>
        <p>Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
      </div>
    </nz-spin>
  </div>

  <!-- AI Suggestion Results -->
  <div *ngIf="aiSuggestion && !isProcessing" class="suggestion-results">
    <!-- Improved file info section layout with better spacing and alignment -->
    <div class="suggestion-header">
      <div class="header-content">
        <div class="file-section">
          <h4>AI ƒë√£ t·∫°o c√¥ng vi·ªác t·ª´ file:</h4>
          <div class="file-info-section">
            <div class="file-details">
              <i nz-icon nzType="file-text" class="file-icon"></i>
              <span class="file-name">{{ fileName }}</span>
              
              <button 
                *ngIf="canPreviewFile()"
                nz-button 
                nzType="link" 
                nzSize="small"
                (click)="previewUploadedFile()"
                class="preview-btn">
                xem file
                <i nz-icon nzType="eye"></i>
              
              </button>
              
              <span *ngIf="!canPreviewFile()" class="file-type-indicator">
                <i nz-icon nzType="info-circle"></i>
                Kh√¥ng th·ªÉ xem tr∆∞·ªõc
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Task Card -->
    <nz-card class="main-task-card" nzTitle="üìã C√¥ng vi·ªác ch√≠nh"
      [nzExtra]="mainTaskActions">
      <ng-template #mainTaskActions>
        <div class="main-task-actions">
          <button nz-button nzType="primary" nzSize="small"
            (click)="assignParentTask()"
            [disabled]="isParentAssigned"
            class="assign-parent-btn">
            <i nz-icon nzType="user-add"></i>
            {{ isParentAssigned ? 'ƒê√£ giao vi·ªác cha' : 'Giao vi·ªác cha' }}
          </button>
        </div>
      </ng-template>
      
      <div class="task-info">
        <h3 class="task-title">{{ aiSuggestion.title }}</h3>
        <div class="task-meta">
          <!-- <nz-tag nzColor="blue">
            <i nz-icon nzType="calendar"></i>
            {{ aiSuggestion.startDate }} - {{ aiSuggestion.endDate }}
          </nz-tag> -->
          <nz-tag nzColor="orange">
            <i nz-icon nzType="branches"></i>
            {{ aiSuggestion.subtasks.length }} c√¥ng vi·ªác con
          </nz-tag>
          <nz-tag [nzColor]="isParentAssigned ? 'green' : 'gold'">
            <i nz-icon [nzType]="isParentAssigned ? 'check-circle' : 'clock-circle'"></i>
            {{ isParentAssigned ? 'ƒê√£ giao vi·ªác cha' : 'Ch∆∞a giao vi·ªác cha' }}
          </nz-tag>
        </div>
        <div class="task-description">
          <h4>M√¥ t·∫£:</h4>
          <p>{{ aiSuggestion.description }}</p>
        </div>
      </div>
    </nz-card>

    <!-- Toggle Subtasks Button -->
    <div class="subtasks-toggle-section">
      <button nz-button nzType="default" nzSize="large"
        class="toggle-subtasks-btn"
        (click)="isSubtasksVisible = !isSubtasksVisible">
        <i nz-icon [nzType]="isSubtasksVisible ? 'up' : 'down'"></i>
        <span>
          {{ isSubtasksVisible ? '·∫®n' : 'Xem' }} c√¥ng vi·ªác con ({{ aiSuggestion.subtasks.length }})
        </span>
      </button>
    </div>

    <!-- Subtasks Section -->
    <div class="subtasks-section"
      [class.visible]="isSubtasksVisible"
      [class.hidden]="!isSubtasksVisible">
      
      <!-- Warning if parent task not assigned -->
      <div *ngIf="isSubtasksVisible && !isParentAssigned" class="parent-warning">
        <nz-alert
          nzType="warning"
          nzMessage="Vui l√≤ng giao vi·ªác cha tr∆∞·ªõc khi giao c√°c vi·ªác con"
          nzShowIcon>
        </nz-alert>
      </div>

      <div class="subtasks-header" *ngIf="isSubtasksVisible">
        <h3>C√°c c√¥ng vi·ªác con ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t</h3>
        <span class="summary-text">
          T·ªïng c·ªông {{ aiSuggestion.subtasks.length }} c√¥ng vi·ªác con
        </span>
      </div>
      
      <div class="subtasks-list" *ngIf="isSubtasksVisible">
        <nz-card *ngFor="let subtask of aiSuggestion.subtasks; let i = index"
          class="subtask-card"
          [class.disabled]="!isParentAssigned"
          [nzTitle]="'Vi·ªác con ' + (i + 1) + ': ' + subtask.title"
          [nzExtra]="subtaskActions">
          <ng-template #subtaskActions>
            <div class="subtask-actions">
              <button nz-button nzType="primary" nzSize="small"
                (click)="assignSubtask(subtask, i)"
                [disabled]="!isParentAssigned"
                class="assign-btn">
                <i nz-icon nzType="user-add"></i>
                Giao vi·ªác con
              </button>
            </div>
          </ng-template>
          
          <div class="subtask-info">
            <!-- <h4 class="subtask-title">{{ subtask.title }}</h4> -->
            <div class="subtask-meta">
              <nz-tag nzColor="cyan" nzSize="small">
                <i nz-icon nzType="calendar"></i>
                {{ subtask.startDate }} - {{ subtask.dueDate }}
              </nz-tag>
            </div>
            <div class="subtask-description">
              <h5>M√¥ t·∫£:</h5>
              <p>{{ subtask.description }}</p>
            </div>
          </div>
        </nz-card>
      </div>
    </div>
  </div>

</div>

<!-- Modal Giao Vi·ªác Cha -->
<app-modal-add-job
  (jobAdded)="handleParentJobAdded($event)">
</app-modal-add-job>

<app-modal-view-file></app-modal-view-file>

<!-- Modal Giao Vi·ªác Con -->
<nz-modal
  [(nzVisible)]="showAssignModal"
  (nzOnCancel)="closeAssignModal()"
  [nzFooter]="null"
  nzWidth="800px">
  
  <ng-container *nzModalContent>
    <div *ngIf="prefilledTask" class="assign-modal-content">
      <div class="ai-child-indicator">
        <nz-tag nzColor="green">
          <i nz-icon nzType="robot"></i>
          Giao vi·ªác con t·ª´ AI - Parent ID: {{ assignedParentTaskId }}
        </nz-tag>
      </div>
      
      <edit-app-misson-item
        [prefilledTask]="prefilledTask"
        [isAiMode]="true"
        [isParentTask]="false"
        (taskAssigned)="handleTaskAssigned($event)"
        (closeEdit)="closeAssignModal()">
      </edit-app-misson-item>
    </div>
  </ng-container>
   <!-- <ng-template #modalFooter>
    <div class="modal-footer-actions">
      <button nz-button nzType="default" (click)="closeAssignModal()">
        H·ªßy b·ªè
      </button>
      <button 
        nz-button 
        nzType="primary" 
        (click)="confirmAssignSubtask()"
        [nzLoading]="isAssigningSubtask">
        <i nz-icon nzType="check"></i>
        X√°c nh·∫≠n giao vi·ªác
      </button>
    </div>
  </ng-template> -->
</nz-modal>
