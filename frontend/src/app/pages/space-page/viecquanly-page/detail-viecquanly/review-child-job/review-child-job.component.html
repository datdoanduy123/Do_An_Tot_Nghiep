<div class="modal">
  <div class="modal-header">
    <div class="button-back" (click)="goBack()">
      <i class="fa-solid fa-arrow-left"></i>
    </div>
    <div class="title">Rà soát công việc</div>
  </div>

  <div class="modal-body">
    <!-- View Toggle -->
    <div class="view-toggle-section">
      <div class="toggle-buttons">
        <button 
          [class]="'toggle-btn ' + (showUserProgress ? 'active' : '')"
          (click)="switchToUserView()">
          <i class="fa-solid fa-user"></i>
          Theo người thực hiện
        </button>
        <button 
          [class]="'toggle-btn ' + (!showUserProgress ? 'active' : '')"
          (click)="switchToUnitView()">
          <i class="fa-solid fa-building"></i>
          Theo đơn vị
        </button>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="select-container">
      <div class="flex-space-between-align-item-start">
        
        <!-- User Filter (when showing user progress) -->
        <div *ngIf="showUserProgress">
          <div>Người thực hiện:</div>
          <nz-select
            nzMode="multiple"
            nzPlaceHolder="Chọn người thực hiện"
            [(ngModel)]="ListselectedUser"
            nzOptionLabelProp="label"
            [nzLoading]="isLoadingUsers"
            style="width: 300px;">
            <nz-option
              *ngFor="let user of ListselectUser"
              [nzValue]="user"
              [nzLabel]="user.fullName">
            </nz-option>
          </nz-select>
        </div>

        <!-- Unit Filter (when showing unit progress) -->
        <div *ngIf="!showUserProgress">
          <div>Lọc theo đơn vị: </div>
          <nz-select
            nzMode="multiple"
            nzPlaceHolder="Chọn đơn vị"
            [(ngModel)]="ListselectedUnit"
            nzOptionLabelProp="label"
            [nzLoading]="isLoadingUnits"
            style="width: 300px;">
            <nz-option
              *ngFor="let unit of ListselectUnit"
              [nzValue]="unit"
              [nzLabel]="unit.unitName">
              <div class="unit-option">
                <div>{{ unit.unitName }}</div>
                <small style="color: #666;">Trưởng: {{ unit.leaderFullName }}</small>
              </div>
            </nz-option>
          </nz-select>
        </div>

        <!-- Date Range -->
        <div class="select-schedule">
          <div>Thời gian</div>
          <nz-range-picker
            [(ngModel)]="dateRange"
            nzFormat="dd/MM/yyyy">
          </nz-range-picker>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="select-action">
        <button nz-button nzType="primary" (click)="review()">
          Rà soát
        </button>
        <button class="synthetic"
          nz-button 
          nzType="default" 
          (click)="showInfo()"
          [nzLoading]="isGeneratingSummary">
          <i class="fa-solid fa-file-text"></i>
          <span>Tổng hợp báo cáo</span>
        </button>
      </div>
    </div>

    <!-- User Progress Table -->
    <div *ngIf="showUserProgress" class="table-container">
      <nz-table
        #fixedTable
        [nzData]="listOfData"
        [nzShowPagination]="true"
        [nzScroll]="{ y: '600px', x: 'max-content' }"
        [nzLoading]="isloadingTable"
        (nzCurrentPageDataChange)="onCurrentPageDataChange($event)">
        
        <thead>
          <tr>
            <th
              nzLeft
              nzWidth="40px"
              [(nzChecked)]="checked"
              [nzIndeterminate]="indeterminate"
              (nzCheckedChange)="onAllChecked($event)">
            </th>
            <th nzLeft nzWidth="150px">Người thực hiện</th>
            <th nzWidth="70px">Kỳ</th>
            <th nzWidth="150px">Thời gian</th>
            <th nzWidth="150px">Trạng thái</th>
            <th nzWidth="200px">Kết quả</th>
            <th nzWidth="200px">Kiến nghị/ Đề xuất</th>
            <th nzWidth= "200px">Phản hồi</th>
            <th nzWidth="200px">File đính kèm</th>
            <th nzWidth="200px">Thao tác</th>
          </tr>
        </thead>

        <tbody>
          <ng-container *ngFor="let group of fixedTable.data">
            <!-- User Group Row -->
            <tr class="group-row">
              <td
                nzLeft
                [nzChecked]="setOfCheckedId.has(group.userId)"
                (nzCheckedChange)="onItemChecked(group.userId, $event)">
              </td>
              <td nzLeft>
                <p>{{ group.userName }}</p>
              </td>
              <td colspan="8"></td>
            </tr>

            <!-- Progress Detail Rows -->
            <ng-container *ngFor="let item of group.progresses">
              <tr>
                <td nzLeft></td>
                <td nzLeft></td>
                <td>Kỳ {{ item.periodIndex }}</td>
                <td>{{ item.scheduledDate }}</td>
                <td>{{ convertStatus(item.status) }}</td>
                <td style="max-width: 150px">{{ item.result }}</td>
                <td style="max-width: 150px">{{ item.suggest }}</td>
                <td style="max-width: 150px">{{ item.feedback }}</td>
                <td style="max-width: 120px">
                  <div nz-popover nzType="primary" [nzPopoverContent]="ViewFile">
                    {{ item.file }}
                  </div>
                  <ng-template #ViewFile>
                    <div class="flex action-file">
                      <i
                        (click)="goReviewFileReport(item.filePath ?? '')"
                        class="fa-regular fa-eye">
                      </i>
                      <i
                        (click)="getLinkFileReport(item.filePath ?? '')"
                        class="fa-solid fa-download m-l-10">
                      </i>
                    </div>
                  </ng-template>
                </td>
                <td style="max-width: 140px">
                  <!-- Actions for user progress -->
                  <ng-container *ngIf="isReportPending(item.status); else checkOtherStatus">
                    <div class="flex" style="gap: 8px; flex-wrap: wrap">
                      <button
                        nz-button
                        nzType="primary"
                        style="background:#28a745!important;border-color:#28a745!important;font-size:12px"
                        (click)="accept(item.progressId)">
                        Chấp nhận
                      </button>
                      <button
                        nz-button
                        nzType="default"
                        style="background:#dc3545!important;color:#fff;border-color:#dc3545!important;font-size:12px"
                        (click)="apporveProgress(item.progressId.toString(), false)">
                        Từ chối
                      </button>
                      <button
                        nz-button
                        nzType="default"
                        style="font-size:12px"
                        (click)="showModalSendRemind(group.userId.toString(), false)">
                        Nhắc nhở
                      </button>
                    </div>
                  </ng-container>
                  <ng-template #checkOtherStatus>
                    <ng-container *ngIf="isNoReport(item.status)">
                      <button
                        nz-button
                        nzType="default"
                        style="font-size:12px"
                        (click)="showModalSendRemind(group.userId.toString(), false)">
                        Nhắc nhở
                      </button>
                    </ng-container>
                    <ng-container *ngIf="isCompleted(item.status)">
                      <span style="color: #28a745; font-weight: 500;">✓ Đã hoàn thành</span>
                    </ng-container>
                  </ng-template>
                </td>
              </tr>
            </ng-container>
          </ng-container>
        </tbody>
      </nz-table>
    </div>

    <!-- Unit Progress Table -->
    <div *ngIf="!showUserProgress" class="table-container">
      <nz-table
        #unitTable
        [nzData]="listOfUnitData"
        [nzShowPagination]="true"
        [nzScroll]="{ y: '600px', x: 'max-content' }"
        [nzLoading]="isloadingTable"
        (nzCurrentPageDataChange)="onCurrentUnitPageDataChange($event)">
        
        <thead>
          <tr>
            <th
              nzLeft
              nzWidth="40px"
              [(nzChecked)]="checked"
              [nzIndeterminate]="indeterminate"
              (nzCheckedChange)="onAllChecked($event)">
            </th>
            <th nzLeft nzWidth="150px">Đơn vị</th>
            <th nzWidth="150px">Trưởng phòng</th>
            <th nzWidth="70px">Kỳ</th>
            <th nzWidth="150px">Thời gian</th>
            <th nzWidth="150px">Trạng thái</th>
            <th nzWidth="200px">Kết quả</th>
            <th nzWidth="200px">Kiến nghị/ Đề xuất</th>
            <th nzWidth="200px">Phản hồi</th>
            <th nzWidth="200px">File đính kèm</th>
            <th nzWidth="200px">Thao tác</th>
          </tr>
        </thead>

        <tbody>
          <ng-container *ngFor="let group of unitTable.data">
            <!-- Unit Group Row -->
            <tr class="group-row">
              <td
                nzLeft
                [nzChecked]="setOfCheckedId.has(group.unitId)"
                (nzCheckedChange)="onItemChecked(group.unitId, $event)">
              </td>
              <td nzLeft>
                <strong>{{ group.unitName }}</strong>
              </td>
              <td>{{ group.leaderFullName }}</td>
              <td colspan="8"></td>
            </tr>

            <!-- Progress Detail Rows -->
            <ng-container *ngFor="let item of group.progresses">
              <tr>
                <td nzLeft></td>
                <td nzLeft></td>
                <td></td>
                <td>Kỳ {{ item.periodIndex }}</td>
                <td>{{ item.scheduledDate }}</td>
                <td>{{ convertStatus(item.status) }}</td>
                <td style="max-width: 150px">{{ item.result }}</td>
                <td style="max-width: 150px">{{ item.suggest }}</td>
                <td style="max-width: 150px">{{ item.feedback }}</td>
                <td style="max-width: 120px">
                  <div nz-popover nzType="primary" [nzPopoverContent]="ViewFileUnit">
                    {{ item.file }}
                  </div>
                  <ng-template #ViewFileUnit>
                    <div class="flex action-file">
                      <i
                        (click)="goReviewFileReport(item.filePath ?? '')"
                        class="fa-regular fa-eye">
                      </i>
                      <i
                        (click)="getLinkFileReport(item.filePath ?? '')"
                        class="fa-solid fa-download m-l-10">
                      </i>
                    </div>
                  </ng-template>
                </td>
                <td style="max-width: 140px">
                  <!-- Actions for unit progress -->
                  <ng-container *ngIf="isReportPending(item.status); else checkOtherUnitStatus">
                    <div class="flex" style="gap: 8px; flex-wrap: wrap">
                      <button
                        nz-button
                        nzType="primary"
                        style="background:#28a745!important;border-color:#28a745!important;font-size:12px"
                        (click)="accept(item.progressId)">
                        Chấp nhận
                      </button>
                      <button
                        nz-button
                        nzType="default"
                        style="background:#dc3545!important;color:#fff;border-color:#dc3545!important;font-size:12px"
                        (click)="apporveProgress(item.progressId.toString(), false)">
                        Từ chối
                      </button>
                      <button
                        nz-button
                        nzType="default"
                        style="font-size:12px"
                        (click)="showModalSendRemind(group.userId.toString(), true, group.unitId)">
                        Nhắc nhở
                      </button>
                    </div>
                  </ng-container>
                  <ng-template #checkOtherUnitStatus>
                    <ng-container *ngIf="isNoReport(item.status)">
                      <button
                        nz-button
                        nzType="default"
                        style="font-size:12px"
                        (click)="showModalSendRemind(group.userId.toString(), true, group.unitId)">
                        Nhắc nhở
                      </button>
                    </ng-container>
                    <ng-container *ngIf="isCompleted(item.status)">
                      <span style="color: #28a745; font-weight: 500;">✓ Đã hoàn thành</span>
                    </ng-container>
                  </ng-template>
                </td>
              </tr>
            </ng-container>
          </ng-container>
        </tbody>
      </nz-table>
    </div>
  </div>
</div>

<!-- Modals -->
<app-modal-send-remind></app-modal-send-remind>
<app-modal-review-progress></app-modal-review-progress>